推荐领域经典之作，介绍深度学习在Youtube推荐系统的应用。网上关于这篇论文的解读很多，每次看都会有新的收获，这次再记录一遍。来自Google的 RecSys'16 论文：

- Deep Neural Networks for YouTube Recommendations

Youtube作为最大的视频网站，在推荐领域主要存在以下三个难点：

- 规模大：海量的视频与用户；
- 实时性：出于用户体验与推荐效果考虑，需要模型以及系统具有"低延时"，能及时响应新内容与用户行为；
- 噪音：主要体现在用户的历史行为往往是稀疏的并且是不完整的，并且没有一个明确的ground truth的满意度signal，同时视频数据是非结构化的



系统整体结构如下，工业界搜索推荐领域的常规操作，第一阶段从海量数据（百万级别）中『召回』比较相关的样本（百或千级别），第二阶段对召回的样本进行『精排』，得到最终的Top样本展现推送给用户。

![Od8mLA](https://cdn.jsdelivr.net/gh/KaiyuanGao/ML-algorithm@master/uPic/Od8mLA.png)

## 召回 Matching

召回整体网络设计如下，从下往上看

![f5Trie](https://cdn.jsdelivr.net/gh/KaiyuanGao/ML-algorithm@master/uPic/f5Trie.png)

#### 1、特征输入

**视频侧**

视频向量是模型在训练阶段优化得到的，初始化就是一个 $[|V|, k]$ 的embedding矩阵，$V$ 为视频总数， $k$ 为视频向量维度。

**用户侧**

用户侧使用的特征就比较多，

- 历史观看视频：通过平均历史观看视频向量得到
- 历史搜索query：对历史query做unigram和bigram分词，向量化之后取平均
- 用户基本信息：性别、年龄、位置、设备等等

**视频年龄**

视频年龄是指当前时间减去视频上传时间的差，上传越早的视频，自然有更多时间“发酵”（相关信号更丰富），也就更有机会成为"更优质"的视频。这属于数据的bias，因此我们需要debias掉。

具体做法就是，在训练时，把视频年龄加入特征中一起训练，但是在线上召回时，将所有视频的该特征全置为0，对新老视频“一视同仁”，有利于召回那些**“虽然上传时间短，但是视频内容与用户更加匹配”的新视频**。对于完成“推新”的要求，这是一个非常好的办法。

#### 2、模型网络

拼接好的输入 过 N层 MLP

#### 3、建模目标

Youtube将“召回”过程建模成一个拥有海量类别的多分类问题，类别总数就是视频库中的视频总数，数量在百万级别。
$$
P\left(w_{t}=i \mid U, C\right)=\frac{e^{v_{i} u}}{\sum_{j \in V} e^{v_{j} u}}
$$
表示用户U在上下文C的情况下，观看第i个视频的概率。其中 $v_i、u$ 分别为上文介绍过的视频向量和用户向量。 

前面说到，这个softmax面向对象是百万级别的视频库，如何高效训练成为一个难点。论文作者采用NLP中的sampled softmax来做，

- 做candidate sampling，即为每个正样本（完成观看），配合几千个负样本，这样一来，分母上的点积、exp只需要做几千次

- 通过以上方法计算出的概率、loss肯定都与原始公式计算出来的有误差，所以再经过importance weighting的方式进行修正

#### 4、在线serving

以上Sampled Softmax算法仅仅是加快了训练速度，预测时，如果要获得准确的观看概率，仍需要计算那包含几百万项的分母，毕竟预测时，你不能再随机抽样负样本了（否则，预测同一个视频两次，因为随机所抽的负样本不同，观看概率也不相同，这样佛系的算法，就没法要了）。

好在我们召回时，并不需要计算每个视频的观看概率。因为，面对同一个用户u，所有候选视频计算softmax时的分母相同，所以召回时，只需要比较分子的大小。所以召回过程，就简化成一个“**给定一个用户向量u，在所有视频向量中，寻找与u点积最大的前N个视频向量**”的搜索问题。Youtube将训练得到的视频向量存入数据库，并建立索引，从而能够大大加快这一搜索过程。

## 排序 Ranking

排序系统和召回比较相似，同样从下往上看

![s3lcy1](https://cdn.jsdelivr.net/gh/KaiyuanGao/ML-algorithm@master/uPic/s3lcy1.png)

#### 1、特征

由于排序阶段所需要处理的数据较召回阶段少很多，因此可以引入更多更精细的特征。其中，**最重要的Signal是描述用户与视频本身或相似视频之间交互的Signal**。比如：

- 用户在该视频所在频道（channel）内观看了多少视频
- 用户最近一次观看与该视频相同主题的视频的时间

还有一些与召回阶段相关的信号，比如：

- 召回源 以及 其召回打分

等等



#### 2、模型网络

如召回阶段，见上图

#### 3、建模目标

模型目标是预测视频的观看时长，使用的是加权LR。正样本为有点击视频（权重为观看时长），负样本为有pv无点击视频（权重为1）。

![2fDwOI](https://cdn.jsdelivr.net/gh/KaiyuanGao/ML-algorithm@master/uPic/2fDwOI.png)





